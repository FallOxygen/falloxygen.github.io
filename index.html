<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>曲名开字母辅助器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0a0c10;
            --fg: #e8eaed;
            --muted: #7a7d85;
            --accent: #f97316;
            --accent-dim: rgba(249, 115, 22, 0.15);
            --card: #12151c;
            --border: #252a36;
            --danger: #ef4444;
            --warning: #eab308;
            --info: #06b6d4;
            --success: #10b981;
        }
        
        * { font-family: 'Noto Sans SC', sans-serif; box-sizing: border-box; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        body { background: var(--bg); color: var(--fg); min-height: 100vh; overflow-x: hidden; }
        
        .bg-layer { position: fixed; inset: 0; pointer-events: none; z-index: 0; }
        .bg-pattern { 
            background-image: 
                linear-gradient(rgba(249, 115, 22, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(249, 115, 22, 0.03) 1px, transparent 1px);
            background-size: 40px 40px;
        }
        .bg-glow { 
            background: 
                radial-gradient(ellipse 60% 50% at 20% 0%, rgba(249, 115, 22, 0.12) 0%, transparent 60%),
                radial-gradient(ellipse 50% 40% at 90% 100%, rgba(6, 182, 212, 0.08) 0%, transparent 50%);
        }
        
        .page { position: absolute; inset: 0; padding: 20px; overflow-y: auto; transition: opacity 0.4s ease, transform 0.4s ease; }
        .page.hidden { opacity: 0; pointer-events: none; transform: translateY(20px); }
        .page.active { opacity: 1; pointer-events: auto; transform: translateY(0); }
        @media (prefers-reduced-motion: reduce) { .page { transition: opacity 0.2s ease; } .page.hidden { transform: none; } }
        
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; }
        .input-area { 
            background: rgba(0, 0, 0, 0.5); 
            border: 1px solid var(--border); 
            border-radius: 12px; 
            color: var(--fg); 
            transition: border-color 0.25s, box-shadow 0.25s; 
        }
        .input-area:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 4px var(--accent-dim); }
        .input-area::placeholder { color: var(--muted); }
        textarea.input-area { resize: vertical; line-height: 1.8; }
        
        .btn { 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            gap: 10px; 
            padding: 14px 28px; 
            border-radius: 12px; 
            font-weight: 600; 
            font-size: 15px; 
            cursor: pointer; 
            transition: all 0.2s ease; 
            border: none; 
        }
        .btn:active { transform: scale(0.97); }
        .btn-primary { background: linear-gradient(135deg, var(--accent) 0%, #ea580c 100%); color: #000; }
        .btn-primary:hover { filter: brightness(1.1); box-shadow: 0 8px 30px var(--accent-dim); }
        .btn-secondary { background: transparent; border: 1px solid var(--border); color: var(--fg); }
        .btn-secondary:hover { border-color: var(--accent); color: var(--accent); }
        .btn-ghost { background: var(--accent-dim); color: var(--accent); }
        .btn-ghost:hover { background: rgba(249, 115, 22, 0.25); }
        .btn-danger { background: rgba(239, 68, 68, 0.12); color: var(--danger); border: 1px solid rgba(239, 68, 68, 0.3); }
        .btn-danger:hover { background: var(--danger); color: white; }
        .btn-warning { background: rgba(234, 179, 8, 0.12); color: var(--warning); border: 1px solid rgba(234, 179, 8, 0.3); }
        .btn-warning:hover { background: var(--warning); color: #000; }
        .btn-sm { padding: 10px 18px; font-size: 13px; }
        
        .tabs { display: flex; gap: 4px; padding: 4px; background: rgba(0, 0, 0, 0.3); border-radius: 12px; margin-bottom: 20px; }
        .tab-btn { flex: 1; padding: 12px 16px; border-radius: 10px; font-size: 14px; font-weight: 500; color: var(--muted); cursor: pointer; transition: all 0.2s; text-align: center; border: none; background: transparent; }
        .tab-btn:hover { color: var(--fg); }
        .tab-btn.active { background: var(--accent-dim); color: var(--accent); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .checkbox-wrap { display: flex; align-items: center; gap: 12px; cursor: pointer; user-select: none; padding: 12px 14px; border-radius: 10px; transition: background 0.2s; }
        .checkbox-wrap:hover { background: rgba(255, 255, 255, 0.03); }
        .checkbox-wrap input { display: none; }
        .checkbox-box { 
            width: 24px; 
            height: 24px; 
            border: 2px solid var(--border); 
            border-radius: 7px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            transition: all 0.2s; 
            flex-shrink: 0; 
        }
        .checkbox-wrap:hover .checkbox-box { border-color: var(--accent); }
        .checkbox-wrap input:checked + .checkbox-box { background: var(--accent); border-color: var(--accent); }
        .checkbox-box svg { opacity: 0; transform: scale(0.5); transition: all 0.15s; }
        .checkbox-wrap input:checked + .checkbox-box svg { opacity: 1; transform: scale(1); }
        .checkbox-wrap.disabled { opacity: 0.4; pointer-events: none; }
        
        .count-input { width: 60px; padding: 8px 10px; background: rgba(0, 0, 0, 0.5); border: 1px solid var(--border); border-radius: 8px; color: var(--fg); text-align: center; font-size: 14px; }
        .count-input:focus { outline: none; border-color: var(--accent); }
        
        .result-display { background: rgba(0, 0, 0, 0.5); border: 1px solid var(--border); border-radius: 12px; line-height: 2.1; letter-spacing: 0.3px; }
        .char-revealed { color: var(--accent); font-weight: 600; }
        .char-hidden { color: var(--muted); }
        .char-space { color: rgba(122, 125, 133, 0.4); }
        .line-number { color: var(--muted); margin-right: 6px; }
        .guessed-line { color: var(--accent); font-weight: 600; margin-bottom: 8px; }
        .remark-line { color: var(--warning); opacity: 0.85; margin-top: 8px; }
        
        .sorted-chars { display: flex; flex-wrap: wrap; gap: 6px; padding: 14px; background: rgba(0, 0, 0, 0.4); border-radius: 10px; min-height: 50px; align-content: center; }
        .char-tag { 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            min-width: 30px; 
            height: 30px; 
            padding: 0 8px; 
            background: var(--accent-dim); 
            border: 1px solid rgba(249, 115, 22, 0.3); 
            border-radius: 6px; 
            font-size: 14px; 
            font-weight: 600; 
            color: var(--accent); 
        }
        
        .stat-card { text-align: center; padding: 20px; }
        .stat-value { font-size: 32px; font-weight: 700; }
        .stat-label { font-size: 13px; color: var(--muted); margin-top: 6px; }
        
        .page-header { display: flex; align-items: center; gap: 16px; margin-bottom: 28px; }
        .back-btn { 
            width: 44px; 
            height: 44px; 
            border-radius: 12px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            background: var(--card); 
            border: 1px solid var(--border); 
            color: var(--fg); 
            cursor: pointer; 
            transition: all 0.2s; 
        }
        .back-btn:hover { border-color: var(--accent); color: var(--accent); }
        
        .timer-display { font-family: 'JetBrains Mono', monospace; font-size: 56px; font-weight: 700; color: var(--accent); text-align: center; padding: 24px; background: rgba(0, 0, 0, 0.4); border-radius: 16px; letter-spacing: 3px; }
        .timer-display.paused { color: var(--warning); }
        .timer-controls { display: flex; gap: 10px; justify-content: center; margin-top: 16px; }
        
        .settlement-header { text-align: center; padding: 32px 20px; border-bottom: 1px solid var(--border); margin-bottom: 28px; }
        .settlement-title { font-size: 32px; font-weight: 700; margin-bottom: 10px; }
        .settlement-subtitle { color: var(--muted); font-size: 15px; }
        
        .toast { 
            position: fixed; 
            bottom: 28px; 
            left: 50%; 
            transform: translateX(-50%) translateY(120px); 
            background: var(--card); 
            border: 1px solid var(--border); 
            padding: 14px 28px; 
            border-radius: 12px; 
            font-size: 14px; 
            z-index: 1000; 
            opacity: 0; 
            transition: all 0.35s ease; 
            pointer-events: none; 
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast.success { border-color: var(--accent); color: var(--accent); }
        .toast.error { border-color: var(--danger); color: var(--danger); }
        .toast.info { border-color: var(--info); color: var(--info); }
        
        .collapse-header { display: flex; align-items: center; justify-content: space-between; padding: 14px; cursor: pointer; border-radius: 10px; transition: background 0.2s; }
        .collapse-header:hover { background: rgba(255, 255, 255, 0.03); }
        .collapse-content { max-height: 0; overflow: hidden; transition: max-height 0.35s ease; }
        .collapse-content.open { max-height: 600px; }
        .collapse-arrow { transition: transform 0.25s; }
        .collapse-header.expanded .collapse-arrow { transform: rotate(180deg); }
        
        .song-line { display: flex; align-items: baseline; padding: 6px 10px; border-radius: 8px; cursor: pointer; transition: background 0.2s; }
        .song-line:hover { background: rgba(255, 255, 255, 0.05); }
        .song-line.hidden-song { display: none; }
        .song-line.revealed-full { background: rgba(16, 184, 129, 0.15); border: 1px solid rgba(16, 184, 129, 0.3); }
        .song-line .masked-title { display: inline; }
        .song-line .full-title { display: none; }
        .song-line.revealed-full .masked-title { display: none; }
        .song-line.revealed-full .full-title { display: inline; color: var(--success); font-weight: 600; }
        .full-reveal-hint { font-size: 12px; color: var(--success); margin-left: 10px; opacity: 0.8; }
        
        .hide-stats { display: flex; align-items: center; gap: 12px; padding: 12px 18px; background: rgba(234, 179, 8, 0.1); border: 1px solid rgba(234, 179, 8, 0.25); border-radius: 10px; margin-bottom: 14px; font-size: 14px; }
        .hide-stats .count { color: var(--warning); font-weight: 700; }
        
        .notice-box { background: rgba(6, 182, 212, 0.1); border: 1px solid rgba(6, 182, 212, 0.25); border-radius: 12px; padding: 16px 20px; margin-bottom: 20px; }
        .notice-box .title { color: var(--info); font-weight: 600; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
        .notice-box .content { color: var(--muted); font-size: 14px; line-height: 1.7; }
        
        .help-box { background: rgba(249, 115, 22, 0.08); border: 1px solid rgba(249, 115, 22, 0.2); border-radius: 12px; padding: 16px 20px; margin-bottom: 20px; }
        .help-box .title { color: var(--accent); font-weight: 600; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
        .help-box .content { color: var(--fg); font-size: 13px; line-height: 1.9; }
        .help-box .step { display: flex; gap: 10px; margin-bottom: 8px; }
        .help-box .step-num { 
            width: 22px; 
            height: 22px; 
            background: var(--accent-dim); 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 12px; 
            font-weight: 600; 
            color: var(--accent); 
            flex-shrink: 0; 
        }
        
        /* 新增样式：上传区域 */
        .upload-zone { border: 2px dashed var(--border); border-radius: 14px; padding: 36px; text-align: center; cursor: pointer; transition: all 0.25s; }
        .upload-zone:hover { border-color: var(--accent); background: var(--accent-dim); }
        .upload-zone.dragover { border-color: var(--accent); background: var(--accent-dim); }
        
        .game-list { max-height: 300px; overflow-y: auto; padding-right: 8px; }
        .game-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; border-radius: 10px; transition: background 0.15s; }
        .game-item:hover { background: rgba(255, 255, 255, 0.03); }
        .game-name { font-weight: 500; flex: 1; }
        .game-count { font-size: 12px; color: var(--muted); background: rgba(255, 255, 255, 0.05); padding: 3px 10px; border-radius: 6px; margin-right: 14px; }
        
        .mode-switch { display: flex; gap: 10px; margin-bottom: 16px; }
        .mode-btn { flex: 1; padding: 12px; border-radius: 10px; font-size: 14px; font-weight: 500; cursor: pointer; border: 1px solid var(--border); background: transparent; color: var(--muted); transition: all 0.2s; }
        .mode-btn:hover { color: var(--fg); }
        .mode-btn.active { background: var(--accent-dim); border-color: var(--accent); color: var(--accent); }
        
        .file-info { display: flex; align-items: center; gap: 12px; padding: 14px 18px; background: rgba(249, 115, 22, 0.1); border: 1px solid rgba(249, 115, 22, 0.2); border-radius: 10px; margin-bottom: 16px; }
        .file-info .filename { flex: 1; font-weight: 500; }
        
        .filter-section { margin-bottom: 18px; }
        .filter-label { font-size: 13px; color: var(--muted); margin-bottom: 10px; display: block; }
        .filter-options { display: flex; flex-wrap: wrap; gap: 10px; }
        .filter-chip { padding: 8px 14px; border-radius: 8px; font-size: 13px; cursor: pointer; border: 1px solid var(--border); background: transparent; color: var(--muted); transition: all 0.15s; }
        .filter-chip:hover { color: var(--fg); border-color: var(--accent); }
        .filter-chip.active { background: var(--accent-dim); border-color: var(--accent); color: var(--accent); }
        
        /* 恢复游戏弹窗 */
        .modal-overlay { 
            position: fixed; 
            inset: 0; 
            background: rgba(0, 0, 0, 0.8); 
            backdrop-filter: blur(8px); 
            z-index: 2000; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            opacity: 0; 
            pointer-events: none; 
            transition: opacity 0.3s ease; 
        }
        .modal-overlay.show { opacity: 1; pointer-events: auto; }
        .modal-content { 
            background: var(--card); 
            border: 1px solid var(--border); 
            border-radius: 20px; 
            padding: 28px; 
            max-width: 420px; 
            width: 90%; 
            transform: scale(0.9); 
            transition: transform 0.3s ease; 
        }
        .modal-overlay.show .modal-content { transform: scale(1); }
        .modal-title { font-size: 22px; font-weight: 700; margin-bottom: 12px; text-align: center; }
        .modal-text { color: var(--muted); font-size: 14px; line-height: 1.7; margin-bottom: 24px; text-align: center; }
        .modal-info { 
            background: rgba(249, 115, 22, 0.1); 
            border: 1px solid rgba(249, 115, 22, 0.2); 
            border-radius: 12px; 
            padding: 16px; 
            margin-bottom: 24px; 
        }
        .modal-info-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border); }
        .modal-info-item:last-child { border-bottom: none; }
        .modal-info-label { color: var(--muted); font-size: 13px; }
        .modal-info-value { font-weight: 600; font-size: 14px; }
        .modal-buttons { display: flex; gap: 12px; }
        .modal-buttons .btn { flex: 1; }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent); }
        
        @media (max-width: 640px) {
            .timer-display { font-size: 40px; }
            .stat-value { font-size: 26px; }
        }
    </style>
</head>
<body class="relative">
    <div class="bg-layer bg-pattern"></div>
    <div class="bg-layer bg-glow"></div>
    <div id="toast" class="toast"></div>
    
    <!-- 恢复游戏弹窗 -->
    <div id="restoreModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-title" style="color: var(--accent);">发现未完成的游戏</div>
            <div class="modal-text">检测到您上次有未完成的游戏，是否继续？</div>
            <div class="modal-info">
                <div class="modal-info-item">
                    <span class="modal-info-label">曲目数量</span>
                    <span class="modal-info-value" id="restoreSongCount">0 首</span>
                </div>
                <div class="modal-info-item">
                    <span class="modal-info-label">已开字符</span>
                    <span class="modal-info-value" id="restoreCharCount">0 个</span>
                </div>
                <div class="modal-info-item">
                    <span class="modal-info-label">已用时间</span>
                    <span class="modal-info-value" id="restoreTime">00:00:00</span>
                </div>
                <div class="modal-info-item">
                    <span class="modal-info-label">揭示率</span>
                    <span class="modal-info-value" id="restorePercent">0%</span>
                </div>
            </div>
            <div class="modal-buttons">
                <button id="restoreNewGame" class="btn btn-secondary">开始新游戏</button>
                <button id="restoreContinue" class="btn btn-primary">继续游戏</button>
            </div>
        </div>
    </div>
    
    <!-- 第一页：编辑 -->
    <div id="page1" class="page active">
        <div class="max-w-2xl mx-auto">
            <header class="mb-6">
                <h1 class="text-3xl font-bold mb-2">曲名开字母辅助器</h1>
                <p class="text-sm" style="color: var(--muted);">导入曲库或手动输入，开始你的猜歌游戏</p>
            </header>
            
            <!-- 个人声明 -->
            <div class="notice-box">
                <div class="title">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="8" x2="12" y2="12"/>
                        <line x1="12" y1="16" x2="12.01" y2="16"/>
                    </svg>
                    个人声明
                </div>
                <div class="content">
                    自己第一次部署网站，有些东西做的不好还请见谅！复制的时候如果复制不了就换个浏览器！还有那个导入在线曲库是屎山代码，大家用的时候注意一下抽取的曲名哈！有什么问题和建议可以到 https://b23.tv/Ykreczp 去评论喵！
                </div>
            </div>
            
            <!-- 标签页切换 -->
            <div class="tabs">
                <button class="tab-btn active" data-tab="import">导入曲库</button>
                <button class="tab-btn" data-tab="manual">手动输入</button>
            </div>
            
            <!-- 导入曲库标签页 -->
            <div id="tab-import" class="tab-content active">
                <div class="card p-6 mb-5">
                    <div id="uploadZone" class="upload-zone">
                        <svg width="44" height="44" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="color: var(--muted); margin: 0 auto 14px;">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="17 8 12 3 7 8"/>
                            <line x1="12" y1="3" x2="12" y2="15"/>
                        </svg>
                        <div style="color: var(--fg); font-weight: 600; margin-bottom: 6px;">点击上传或拖拽 TXT 文件</div>
                        <div style="color: var(--muted); font-size: 13px;">支持标准格式的曲库文件</div>
                    </div>
                    <input type="file" id="fileInput" accept=".txt" style="display: none;">
                    
                    <!-- 在线曲库导入按钮 -->
                    <button id="importOnlineBtn" class="btn btn-secondary w-full mt-4">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="2" y1="12" x2="22" y2="12"/>
                            <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
                        </svg>
                        导入在线曲库
                    </button>
                </div>
                
                <div id="parsedSection" style="display: none;">
                    <div class="card p-6 mb-5">
                        <div class="file-info">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: var(--accent);">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14 2 14 8 20 8"/>
                            </svg>
                            <span id="fileName" class="filename">-</span>
                            <span id="fileStats" style="color: var(--muted); font-size: 13px;"></span>
                            <button id="clearFile" class="btn btn-danger btn-sm">移除</button>
                        </div>
                    </div>
                    
                    <div class="card p-6 mb-5">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="font-semibold flex items-center gap-2">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: var(--accent);">
                                    <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
                                    <line x1="8" y1="21" x2="16" y2="21"/>
                                    <line x1="12" y1="17" x2="12" y2="21"/>
                                </svg>
                                选择游戏范围
                            </h2>
                            <div class="flex gap-2">
                                <button id="selectAll" class="btn btn-ghost btn-sm">全选</button>
                                <button id="selectNone" class="btn btn-secondary btn-sm">清空</button>
                            </div>
                        </div>
                        <div id="gameList" class="game-list"></div>
                    </div>
                    
                    <div class="card p-6 mb-5">
                        <h2 class="font-semibold flex items-center gap-2 mb-4">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: var(--accent);">
                                <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>
                            </svg>
                            曲目过滤
                        </h2>
                        <div class="filter-section">
                            <span class="filter-label">只有</span>
                            <div class="filter-options" data-filter-type="only">
                                <button class="filter-chip" data-filter="letter">字母</button>
                                <button class="filter-chip" data-filter="japanese">日文</button>
                                <button class="filter-chip" data-filter="hanzi">汉字</button>
                                <button class="filter-chip" data-filter="symbol">符号</button>
                            </div>
                        </div>
                        <div class="filter-section">
                            <span class="filter-label">包含</span>
                            <div class="filter-options" data-filter-type="include">
                                <button class="filter-chip" data-filter="letter">字母</button>
                                <button class="filter-chip" data-filter="japanese">日文</button>
                                <button class="filter-chip" data-filter="hanzi">汉字</button>
                                <button class="filter-chip" data-filter="symbol">符号</button>
                            </div>
                        </div>
                        <div class="filter-section">
                            <span class="filter-label">没有</span>
                            <div class="filter-options" data-filter-type="exclude">
                                <button class="filter-chip" data-filter="letter">字母</button>
                                <button class="filter-chip" data-filter="japanese">日文</button>
                                <button class="filter-chip" data-filter="hanzi">汉字</button>
                                <button class="filter-chip" data-filter="symbol">符号</button>
                            </div>
                        </div>
                        <div class="flex items-center justify-between mt-4 pt-4" style="border-top: 1px solid var(--border);">
                            <span id="filterCount" style="color: var(--muted); font-size: 13px;">符合条件的曲目: 0 首</span>
                            <button id="clearFilters" class="btn btn-secondary btn-sm">清除过滤</button>
                        </div>
                    </div>
                    
                    <div class="card p-6 mb-5">
                        <h2 class="font-semibold flex items-center gap-2 mb-4">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: var(--accent);">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 6v6l4 2"/>
                            </svg>
                            抽取设置
                        </h2>
                        <div class="mode-switch">
                            <button id="modeEqual" class="mode-btn active">总数量模式</button>
                            <button id="modeCustom" class="mode-btn">定制数量模式</button>
                        </div>
                        <div id="equalMode" class="mb-4">
                            <label class="block text-sm mb-2" style="color: var(--muted);">总抽取数量</label>
                            <input type="number" id="totalCount" class="count-input w-full" style="width: 100%;" min="1" placeholder="输入总数">
                            <p class="text-xs mt-2" style="color: var(--muted);">将从选中的范围内随机抽取指定数量的曲目</p>
                        </div>
                        <div id="customMode" style="display: none;">
                            <p class="text-sm mb-3" style="color: var(--muted);">为每个游戏范围指定抽取数量：</p>
                            <div id="customCounts" class="space-y-2 max-h-[280px] overflow-y-auto"></div>
                        </div>
                        <button id="generateBtn" class="btn btn-primary w-full mt-4">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
                            </svg>
                            生成曲目列表
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 手动输入标签页 -->
            <div id="tab-manual" class="tab-content">
                <div class="card p-6 mb-5">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="font-semibold flex items-center gap-2">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: var(--accent);">
                                <path d="M9 18V5l12-2v13"/>
                                <circle cx="6" cy="18" r="3"/>
                                <circle cx="18" cy="16" r="3"/>
                            </svg>
                            曲名序列
                        </h2>
                        <button id="clearSongs" class="btn btn-ghost btn-sm">清空</button>
                    </div>
                    <textarea id="songInput" class="input-area mono w-full p-4" style="min-height: 260px;" placeholder="粘贴曲名列表，支持以下格式：&#10;&#10;1.Distorted Fate&#10;2.Xterfusion&#10;3.INTERNET YAMERO&#10;&#10;或每行一首曲名（无需序号）"></textarea>
                </div>
            </div>
            
            <div class="card p-6 mb-5">
                <div class="collapse-header" id="sortToggle">
                    <h2 class="font-semibold flex items-center gap-2">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: var(--accent);">
                            <line x1="4" y1="6" x2="20" y2="6"/>
                            <line x1="4" y1="12" x2="16" y2="12"/>
                            <line x1="4" y1="18" x2="12" y2="18"/>
                        </svg>
                        排列选项
                    </h2>
                    <svg class="collapse-arrow" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 12 15 18 9"/>
                    </svg>
                </div>
                <div id="sortContent" class="collapse-content">
                    <div class="pt-4">
                        <div class="flex flex-wrap gap-6 mb-4">
                            <label id="randomSortLabel" class="checkbox-wrap">
                                <input type="checkbox" id="randomSort">
                                <span class="checkbox-box">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#000" stroke-width="3">
                                        <polyline points="20 6 9 17 4 12"/>
                                    </svg>
                                </span>
                                <span>随机排列</span>
                            </label>
                            <label id="lengthSortLabel" class="checkbox-wrap">
                                <input type="checkbox" id="lengthSort">
                                <span class="checkbox-box">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#000" stroke-width="3">
                                        <polyline points="20 6 9 17 4 12"/>
                                    </svg>
                                </span>
                                <span>按长度排列</span>
                            </label>
                        </div>
                        <button id="applySort" class="btn btn-secondary btn-sm w-full">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 2v6h-6M3 12a9 9 0 0 1 15-6.7L21 8M3 22v-6h6M21 12a9 9 0 0 1-15 6.7L3 16"/>
                            </svg>
                            应用排列
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="card p-6 mb-5">
                <h2 class="font-semibold flex items-center gap-2 mb-4">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: var(--accent);">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/>
                    </svg>
                    备注信息
                </h2>
                <input type="text" id="remarkInput" class="input-area w-full p-4" placeholder="输入备注，如：曲目范围 Lv.15+ 等（可选）">
            </div>
            
            <div class="card p-6 mb-5">
                <h2 class="font-semibold flex items-center gap-2 mb-4">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: var(--accent);">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l-.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </svg>
                    游戏选项
                </h2>
                <label class="checkbox-wrap">
                    <input type="checkbox" id="spaceAsStar">
                    <span class="checkbox-box">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#000" stroke-width="3">
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                    </span>
                    <span>空格视为星号（空格也会被隐藏）</span>
                </label>
            </div>
            
            <button id="parseBtn" class="btn btn-primary w-full text-base py-4">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
                </svg>
                解析并开始游戏
            </button>
            
            <div id="statusHint" class="mt-5 text-center text-sm" style="color: var(--muted);"></div>
        </div>
    </div>
    
    <!-- 第二页：游戏进行中 -->
    <div id="page2" class="page hidden">
        <div class="max-w-2xl mx-auto">
            <div class="page-header">
                <button id="backBtn" class="back-btn" aria-label="返回编辑">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 12H5M12 19l-7-7 7-7"/>
                    </svg>
                </button>
                <div>
                    <h1 class="text-2xl font-bold">猜测进行中</h1>
                    <p class="text-xs" style="color: var(--muted);">点击曲名可显示完整名称，再次点击隐藏</p>
                </div>
            </div>
            
            <!-- 计时器 -->
            <div class="card p-6 mb-5">
                <div id="timerDisplay" class="timer-display">00:00:00</div>
                <div class="timer-controls">
                    <button id="pauseBtn" class="btn btn-warning">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="6" y="4" width="4" height="16"/>
                            <rect x="14" y="4" width="4" height="16"/>
                        </svg>
                        暂停
                    </button>
                    <button id="endGameBtn" class="btn btn-danger">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                            <polyline points="22 4 12 14.01 9 11.01"/>
                        </svg>
                        结束游戏
                    </button>
                </div>
            </div>
            
            <div class="card p-6 mb-5">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="font-semibold flex items-center gap-2">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: var(--accent);">
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                            <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                        </svg>
                        开启字符
                    </h2>
                    <button id="resetChars" class="btn btn-ghost btn-sm">重置</button>
                </div>
                <input type="text" id="charInput" class="input-area mono w-full p-4 text-xl text-center" style="letter-spacing: 0.25em;" placeholder="输入任意字符..." autocomplete="off" spellcheck="false">
                <div class="mt-4">
                    <div class="text-xs mb-2" style="color: var(--muted);">已排序的开启字符：</div>
                    <div id="sortedCharsDisplay" class="sorted-chars mono">
                        <span style="color: var(--muted);">-</span>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-3 gap-4 mb-5">
                <div class="card stat-card">
                    <div id="statSongs" class="stat-value mono" style="color: var(--accent);">0</div>
                    <div class="stat-label">曲名数</div>
                </div>
                <div class="card stat-card">
                    <div id="statChars" class="stat-value mono" style="color: var(--warning);">0</div>
                    <div class="stat-label">已开字符</div>
                </div>
                <div class="card stat-card">
                    <div id="statPercent" class="stat-value mono">0%</div>
                    <div class="stat-label">揭示率</div>
                </div>
            </div>
            
            <div class="card p-5 mb-5">
                <div class="flex items-center justify-between">
                    <div id="hideStats" class="hide-stats flex-1" style="display: none;">
                        <span>已隐藏</span>
                        <span class="count" id="hiddenCount">0</span>
                        <span>首曲目</span>
                    </div>
                    <button id="hideRevealed" class="btn btn-warning w-full">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
                            <line x1="1" y1="1" x2="23" y2="23"/>
                        </svg>
                        隐藏已猜出的曲目
                    </button>
                </div>
                <p class="text-xs mt-3" style="color: var(--muted);">点击曲目显示完整曲名后，点击此按钮将其从列表中移除</p>
            </div>
            
            <div class="card p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="font-semibold flex items-center gap-2">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: var(--accent);">
                            <polygon points="12 2 2 7 12 12 22 7 12 2"/>
                            <polyline points="2 17 12 22 22 17"/>
                            <polyline points="2 12 12 17 22 12"/>
                        </svg>
                        解析结果
                    </h2>
                    <button id="copyBtn" class="btn btn-secondary btn-sm">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                        </svg>
                        复制结果
                    </button>
                </div>
                <div id="resultDisplay" class="result-display mono p-4 min-h-[300px] max-h-[450px] overflow-auto whitespace-pre-wrap"></div>
            </div>
        </div>
    </div>
    
    <!-- 第三页：结算 -->
    <div id="page3" class="page hidden">
        <div class="max-w-2xl mx-auto">
            <div class="settlement-header">
                <div class="settlement-title">游戏结束</div>
                <div class="settlement-subtitle">结算信息已生成，可复制分享</div>
            </div>
            
            <div class="card p-6 mb-5">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="font-semibold flex items-center gap-2">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: var(--accent);">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                            <line x1="16" y1="13" x2="8" y2="13"/>
                            <line x1="16" y1="17" x2="8" y2="17"/>
                            <polyline points="10 9 9 9 8 9"/>
                        </svg>
                        结算信息
                    </h2>
                    <button id="copySettlement" class="btn btn-secondary btn-sm">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                        </svg>
                        复制
                    </button>
                </div>
                <textarea id="settlementText" class="input-area mono w-full p-4" style="min-height: 200px; resize: vertical;" readonly></textarea>
            </div>
            
            <div class="card p-6 mb-5">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="font-semibold flex items-center gap-2">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: var(--accent);">
                            <polygon points="12 2 2 7 12 12 22 7 12 2"/>
                            <polyline points="2 17 12 22 22 17"/>
                            <polyline points="2 12 12 17 22 12"/>
                        </svg>
                        完整题面
                    </h2>
                    <button id="copyQuestions" class="btn btn-secondary btn-sm">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                        </svg>
                        复制
                    </button>
                </div>
                <textarea id="questionsText" class="input-area mono w-full p-4" style="min-height: 220px; resize: vertical;" readonly></textarea>
            </div>
            
            <div class="flex gap-4">
                <button id="newGameBtn" class="btn btn-primary flex-1">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 2v6h-6M3 12a9 9 0 0 1 15-6.7L21 8M3 22v-6h6M21 12a9 9 0 0 1-15 6.7L3 16"/>
                    </svg>
                    开始新游戏
                </button>
                <button id="backToEditBtn" class="btn btn-secondary flex-1">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 12H5M12 19l-7-7 7-7"/>
                    </svg>
                    返回编辑
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // ========== 支持的游戏列表 ==========
        const SUPPORTED_GAMES = [
            "Phigros", "Arcaea", "Orzmic", "Milthm", "Berry Melody", "Lanota", 
            "Rotaeno", "Cytus II", "KALPA", "Muse Dash", "Paradigm:Reboot", 
            "TAKUMI³", "PJSK", "maimai", "CHUNITHM", "オンゲキ", "Notanote", 
            "Rizline", "DanceRail3", "vivid/stasis", "Groove Coaster", "ChainBeeT", 
            "Liminality", "RYCEAM", "Dynamix", "Deemo II", "WACCA", "OverRapid", 
            "SDVX", "太鼓达人", "Circle of Sparks", "Polytone", "SEVEN's CODE", 
            "SHINOBI SLASH", "Simple", "Sparkline", "Siglota", "Twirdora", 
            "Tone Sphere", "WAVEAT", "Beatmania IIDX", "BanG Dream!", 
            "DJMAX RESPECT V", "BOF", "米哈游", "东方Project", "UNDERTALE", 
            "Minecraft", "osu", "Malody", "(慎选)曲师曲目大杂烩", "ADOFAI"
        ];
        
        // 在线曲库地址
        const ONLINE_LIBRARY_URL = 'https://raw.githubusercontent.com/FallOxygen/falloxygen.github.io/main/libraries/Songs.txt';
        
        // ========== 字符类型判断 ==========
        function isLetter(c) {
            const code = c.charCodeAt(0);
            return (code >= 65 && code <= 90) || (code >= 97 && code <= 122);
        }
        
        function isHiragana(c) {
            const code = c.charCodeAt(0);
            return code >= 0x3040 && code <= 0x309F;
        }
        
        function isKatakana(c) {
            const code = c.charCodeAt(0);
            return code >= 0x30A0 && code <= 0x30FF;
        }
        
        function isJapanese(c) {
            return isHiragana(c) || isKatakana(c);
        }
        
        function isHanzi(c) {
            const code = c.charCodeAt(0);
            return (code >= 0x4E00 && code <= 0x9FFF) || (code >= 0x3400 && code <= 0x4DBF);
        }
        
        function isSymbol(c) {
            if (c === ' ' || c === '　') return false;
            return !isLetter(c) && !isJapanese(c) && !isHanzi(c);
        }
        
        function checkFilter(song, filterType, filterValue) {
            const hasLetter = [...song].some(isLetter);
            const hasJapanese = [...song].some(isJapanese);
            const hasHanzi = [...song].some(isHanzi);
            const hasSymbol = [...song].some(isSymbol);
            
            const onlyLetter = [...song].every(c => isLetter(c) || c === ' ' || c === '　');
            const onlyJapanese = [...song].every(c => isJapanese(c) || c === ' ' || c === '　');
            const onlyHanzi = [...song].every(c => isHanzi(c) || c === ' ' || c === '　');
            const onlySymbol = [...song].every(c => isSymbol(c) || c === ' ' || c === '　');
            
            switch (filterValue) {
                case 'letter':
                    if (filterType === 'only') return onlyLetter;
                    if (filterType === 'include') return hasLetter;
                    if (filterType === 'exclude') return !hasLetter;
                    break;
                case 'japanese':
                    if (filterType === 'only') return onlyJapanese;
                    if (filterType === 'include') return hasJapanese;
                    if (filterType === 'exclude') return !hasJapanese;
                    break;
                case 'hanzi':
                    if (filterType === 'only') return onlyHanzi;
                    if (filterType === 'include') return hasHanzi;
                    if (filterType === 'exclude') return !hasHanzi;
                    break;
                case 'symbol':
                    if (filterType === 'only') return onlySymbol;
                    if (filterType === 'include') return hasSymbol;
                    if (filterType === 'exclude') return !hasSymbol;
                    break;
            }
            return true;
        }
        
        // ========== 字符排序规则 ==========
        const charPriority = {
            digit: 1, upperLetter: 2, lowerLetter: 3, hiragana: 4, katakana: 5,
            punctuation: 6, hanzi: 7, other: 99
        };
        
        function getCharType(c) {
            const code = c.charCodeAt(0);
            if (code >= 48 && code <= 57) return 'digit';
            if (code >= 65 && code <= 90) return 'upperLetter';
            if (code >= 97 && code <= 122) return 'lowerLetter';
            if (code >= 0x3040 && code <= 0x309F) return 'hiragana';
            if (code >= 0x30A0 && code <= 0x30FF) return 'katakana';
            const puncts = '!"#$%&\'()*+,-./:;<=>?@[\\]^_`{|}~！＂＃＄％＆＇（）＊＋，－．／：；＜＝＞？＠［＼］＾＿｀｛｜｝～「」『』【】（）、。・…—';
            if (puncts.includes(c)) return 'punctuation';
            if ((code >= 0x4E00 && code <= 0x9FFF) || (code >= 0x3400 && code <= 0x4DBF)) return 'hanzi';
            return 'other';
        }
        
        function sortChars(chars) {
            return chars.sort((a, b) => {
                const pA = charPriority[getCharType(a)];
                const pB = charPriority[getCharType(b)];
                return pA !== pB ? pA - pB : a.localeCompare(b, 'ja');
            });
        }
        
        // ========== IndexedDB ==========
        const DB_NAME = 'SongLetterHelperDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'library';
        let db = null;
        
        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                request.onupgradeneeded = (event) => {
                    const database = event.target.result;
                    if (!database.objectStoreNames.contains(STORE_NAME)) {
                        database.createObjectStore(STORE_NAME, { keyPath: 'id' });
                    }
                };
            });
        }
        
        function saveToDB(key, data) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.put({ id: key, data: data });
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }
        
        function loadFromDB(key) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.get(key);
                request.onsuccess = () => resolve(request.result ? request.result.data : null);
                request.onerror = () => reject(request.error);
            });
        }
        
        // ========== 状态 ==========
        const STORAGE_KEY = 'songLetterHelper_v10';
        
        let state = {
            currentPage: 1,
            activeTab: 'import',
            songInputText: '',
            songs: [],
            remark: '',
            sortType: 'none',
            openedChars: '',
            spaceAsStar: false,
            revealedFullIndices: [],
            hiddenIndices: [],
            timerSeconds: 0,
            timerRunning: false,
            timerPaused: false,
            gameStartTime: null,
            totalPauseTime: 0,
            pauseStartTime: null,
            guessedSongs: [],
            currentRevealPercent: 0,
            // 新增：曲库相关
            fileName: '',
            selectedGames: [],
            customCounts: {},
            extractMode: 'equal',
            totalCount: 10,
            filters: { only: [], include: [], exclude: [] }
        };
        
        let gameData = {};
        let elements = {};
        let timerInterval = null;
        
        // ========== 工具函数 ==========
        function showToast(message, type = 'success') {
            const toast = elements.toast;
            toast.textContent = message;
            toast.className = 'toast ' + type;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2800);
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function parseSongs(text) {
            if (!text.trim()) return [];
            const lines = text.trim().split('\n');
            const result = [];
            for (const line of lines) {
                const trimmed = line.trim();
                if (!trimmed) continue;
                const match = trimmed.match(/^\d+[.)\s:：]+(.+)$/);
                result.push(match ? match[1].trim() : trimmed);
            }
            return result;
        }
        
        function revealChar(char, openedSet, spaceAsStar) {
            if (char === ' ' || char === '　') {
                return spaceAsStar ? '*' : char;
            }
            if (openedSet.has(char)) return char;
            const lower = char.toLowerCase();
            for (const c of openedSet) {
                if (c.toLowerCase() === lower) return char;
            }
            return '*';
        }
        
        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        }
        
        function formatTimeReadable(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            
            if (h > 0) {
                return `${h}小时${m}分钟${s}秒`;
            } else if (m > 0) {
                return `${m}分钟${s}秒`;
            } else {
                return `${s}秒`;
            }
        }
        
        function formatAverageTime(seconds) {
            if (seconds < 60) {
                return `${seconds.toFixed(1)}秒`;
            } else if (seconds < 3600) {
                const m = Math.floor(seconds / 60);
                const s = Math.round(seconds % 60);
                return s > 0 ? `${m}分${s}秒` : `${m}分钟`;
            } else {
                const h = Math.floor(seconds / 3600);
                const m = Math.round((seconds % 3600) / 60);
                return m > 0 ? `${h}小时${m}分钟` : `${h}小时`;
            }
        }
        
        // ========== 存储函数 ==========
        function saveState() {
            state.songInputText = elements.songInput.value;
            state.remark = elements.remarkInput.value;
            state.sortType = elements.randomSort.checked ? 'random' : (elements.lengthSort.checked ? 'length' : 'none');
            state.openedChars = elements.charInput.value;
            state.spaceAsStar = elements.spaceAsStar.checked;
            state.totalCount = parseInt(elements.totalCount.value) || 10;
            state.extractMode = elements.modeEqual.classList.contains('active') ? 'equal' : 'custom';
            
            const checked = elements.gameList.querySelectorAll('input[type="checkbox"]:checked');
            state.selectedGames = Array.from(checked).map(cb => cb.dataset.game);
            
            if (state.extractMode === 'custom') {
                state.customCounts = {};
                elements.customCountsDiv.querySelectorAll('.custom-count-input').forEach(input => {
                    state.customCounts[input.dataset.game] = parseInt(input.value) || 0;
                });
            }
            
            state.filters = { only: [], include: [], exclude: [] };
            document.querySelectorAll('.filter-chip.active').forEach(chip => {
                const type = chip.parentElement.dataset.filterType;
                const value = chip.dataset.filter;
                state.filters[type].push(value);
            });
            
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
            } catch (e) {
                console.warn('无法保存状态:', e);
            }
        }
        
        function loadState() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    const parsed = JSON.parse(saved);
                    state = { ...state, ...parsed };
                    return true;
                }
            } catch (e) {
                console.warn('无法加载状态:', e);
            }
            return false;
        }
        
        function clearGameState() {
            state.currentPage = 1;
            state.songs = [];
            state.openedChars = '';
            state.revealedFullIndices = [];
            state.hiddenIndices = [];
            state.timerSeconds = 0;
            state.timerRunning = false;
            state.timerPaused = false;
            state.gameStartTime = null;
            state.totalPauseTime = 0;
            state.pauseStartTime = null;
            state.guessedSongs = [];
            state.currentRevealPercent = 0;
            
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
            } catch (e) {
                console.warn('无法保存状态:', e);
            }
        }
        
        // ========== 计时器函数 ==========
        function startTimer() {
            if (timerInterval) return;
            
            state.timerRunning = true;
            state.timerPaused = false;
            state.gameStartTime = Date.now() - (state.timerSeconds * 1000) - state.totalPauseTime;
            
            timerInterval = setInterval(() => {
                if (!state.timerPaused) {
                    state.timerSeconds = Math.floor((Date.now() - state.gameStartTime - state.totalPauseTime) / 1000);
                    updateTimerDisplay();
                    saveState();
                }
            }, 1000);
            
            updatePauseButton();
        }
        
        function pauseTimer() {
            if (!state.timerRunning) return;
            
            if (state.timerPaused) {
                state.timerPaused = false;
                state.totalPauseTime += Date.now() - state.pauseStartTime;
                state.pauseStartTime = null;
            } else {
                state.timerPaused = true;
                state.pauseStartTime = Date.now();
            }
            
            updatePauseButton();
            saveState();
        }
        
        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            state.timerRunning = false;
            state.timerPaused = false;
        }
        
        function resetTimer() {
            stopTimer();
            state.timerSeconds = 0;
            state.totalPauseTime = 0;
            state.pauseStartTime = null;
            state.gameStartTime = null;
            updateTimerDisplay();
        }
        
        function updateTimerDisplay() {
            const display = document.getElementById('timerDisplay');
            display.textContent = formatTime(state.timerSeconds);
            display.classList.toggle('paused', state.timerPaused);
        }
        
        function updatePauseButton() {
            const btn = document.getElementById('pauseBtn');
            if (state.timerPaused) {
                btn.innerHTML = `
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="5 3 19 12 5 21 5 3"/>
                    </svg>
                    继续
                `;
            } else {
                btn.innerHTML = `
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="6" y="4" width="4" height="16"/>
                        <rect x="14" y="4" width="4" height="16"/>
                    </svg>
                    暂停
                `;
            }
        }
        
        // ========== 结算函数 ==========
        function showSettlement() {
            stopTimer();
            
            const totalSongs = state.songs.length;
            const guessedCount = state.hiddenIndices.length;
            const openedChars = state.openedChars.length;
            const guessedPercent = state.currentRevealPercent;
            
            const avgTimePerSong = totalSongs > 0 ? state.timerSeconds / totalSongs : 0;
            const avgTimePerChar = openedChars > 0 ? state.timerSeconds / openedChars : 0;
            
            let settlementText = `本局开字母结算：\n`;
            settlementText += `用时：${formatTimeReadable(state.timerSeconds)}\n`;
            settlementText += `曲目总数：${totalSongs}首`;
            if (avgTimePerSong > 0) {
                settlementText += `（平均${formatAverageTime(avgTimePerSong)}/题）`;
            }
            settlementText += `\n`;
            settlementText += `开启字符数：${openedChars}个`;
            if (avgTimePerChar > 0) {
                settlementText += `（平均${formatAverageTime(avgTimePerChar)}/个）`;
            }
            settlementText += `\n`;
            settlementText += `揭开字符率：${guessedPercent}%`;
            
            document.getElementById('settlementText').value = settlementText;
            
            let questionsText = state.songs.map((song, idx) => `${idx + 1}.${song}`).join('\n');
            if (state.remark.trim()) {
                questionsText += `\n[${state.remark.trim()}]`;
            }
            
            document.getElementById('questionsText').value = questionsText;
            
            // 清除游戏状态
            clearGameState();
            
            switchToPage(3);
        }
        
        // ========== 页面切换 ==========
        function switchToPage(pageNum, isRestore = false) {
            state.currentPage = pageNum;
            saveState();
            
            document.querySelectorAll('.page').forEach(p => {
                p.classList.remove('active');
                p.classList.add('hidden');
            });
            
            const pageEl = document.getElementById('page' + pageNum);
            pageEl.classList.remove('hidden');
            pageEl.classList.add('active');
            
            if (pageNum === 1) {
                updateStatusHint();
                resetTimer();
            } else if (pageNum === 2) {
                renderResult();
                if (isRestore) {
                    // 恢复游戏时，计时器保持暂停状态
                    state.timerRunning = true;
                    state.timerPaused = true;
                    state.pauseStartTime = Date.now();
                    updateTimerDisplay();
                    updatePauseButton();
                } else {
                    startTimer();
                }
            } else if (pageNum === 3) {
                stopTimer();
            }
        }
        
        function switchTab(tabName) {
            state.activeTab = tabName;
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tabName);
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.toggle('active', content.id === 'tab-' + tabName);
            });
            saveState();
        }
        
        // ========== 曲库解析 ==========
        function parseLibrary(text) {
            const lines = text.split('\n');
            const data = {};
            let currentGame = null;
            
            for (const line of lines) {
                const trimmed = line.trim();
                if (!trimmed) continue;
                
                const tagMatch = trimmed.match(/^\[(.+)\]$/);
                if (tagMatch) {
                    const tagName = tagMatch[1].trim();
                    if (SUPPORTED_GAMES.includes(tagName)) {
                        currentGame = tagName;
                        if (!data[currentGame]) data[currentGame] = [];
                        continue;
                    }
                }
                
                if (currentGame && trimmed) {
                    const songMatch = trimmed.match(/^\d+[.)\s:：]+(.+)$/);
                    const songName = songMatch ? songMatch[1].trim() : trimmed;
                    if (songName) data[currentGame].push(songName);
                }
            }
            
            for (const game in data) {
                if (data[game].length === 0) delete data[game];
            }
            
            return data;
        }
        
        function renderGameList() {
            const games = Object.keys(gameData).sort((a, b) => {
                return SUPPORTED_GAMES.indexOf(a) - SUPPORTED_GAMES.indexOf(b);
            });
            
            elements.gameList.innerHTML = games.map(game => {
                const count = gameData[game].length;
                const checked = state.selectedGames.includes(game) ? 'checked' : '';
                return `
                    <div class="game-item">
                        <label class="checkbox-wrap flex-1">
                            <input type="checkbox" data-game="${escapeHtml(game)}" ${checked}>
                            <span class="checkbox-box">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#000" stroke-width="3">
                                    <polyline points="20 6 9 17 4 12"/>
                                </svg>
                            </span>
                            <span class="game-name">${escapeHtml(game)}</span>
                            <span class="game-count">${count} 首</span>
                        </label>
                    </div>
                `;
            }).join('');
            
            updateFileStats();
            updateCustomCounts();
            updateFilterCount();
        }
        
        function updateFileStats() {
            const totalGames = Object.keys(gameData).length;
            const totalSongs = Object.values(gameData).reduce((sum, arr) => sum + arr.length, 0);
            document.getElementById('fileStats').textContent = `${totalGames} 个游戏 / ${totalSongs} 首曲目`;
        }
        
        function updateCustomCounts() {
            const games = Object.keys(gameData);
            elements.customCountsDiv.innerHTML = games.map(game => {
                const count = gameData[game].length;
                const savedCount = state.customCounts[game] || 0;
                const checked = state.selectedGames.includes(game);
                return `
                    <div class="flex items-center gap-3 p-2 rounded-lg ${checked ? '' : 'opacity-40'}">
                        <span class="flex-1 text-sm">${escapeHtml(game)}</span>
                        <span class="text-xs" style="color: var(--muted);">共 ${count} 首</span>
                        <input type="number" class="count-input custom-count-input" data-game="${escapeHtml(game)}" 
                               value="${savedCount}" min="0" max="${count}" ${checked ? '' : 'disabled'}>
                    </div>
                `;
            }).join('');
        }
        
        // ========== 过滤功能 ==========
        function getFilteredSongs(songs) {
            const { only, include, exclude } = state.filters;
            return songs.filter(song => {
                for (const f of only) {
                    if (!checkFilter(song, 'only', f)) return false;
                }
                for (const f of include) {
                    if (!checkFilter(song, 'include', f)) return false;
                }
                for (const f of exclude) {
                    if (!checkFilter(song, 'exclude', f)) return false;
                }
                return true;
            });
        }
        
        function updateFilterCount() {
            const selectedGames = Array.from(elements.gameList.querySelectorAll('input[type="checkbox"]:checked'))
                .map(cb => cb.dataset.game);
            
            let allSongs = [];
            for (const game of selectedGames) {
                if (gameData[game]) {
                    allSongs = allSongs.concat(gameData[game]);
                }
            }
            
            const filtered = getFilteredSongs(allSongs);
            document.getElementById('filterCount').textContent = `符合条件的曲目: ${filtered.length} 首`;
        }
        
        // ========== 抽取功能 ==========
        function generateSongs() {
            const selectedGames = Array.from(elements.gameList.querySelectorAll('input[type="checkbox"]:checked'))
                .map(cb => cb.dataset.game);
            
            if (selectedGames.length === 0) {
                showToast('请至少选择一个游戏范围', 'error');
                return;
            }
            
            const gameSongMap = {};
            for (const game of selectedGames) {
                if (gameData[game]) {
                    gameSongMap[game] = getFilteredSongs([...gameData[game]]);
                }
            }
            
            const totalFiltered = Object.values(gameSongMap).reduce((sum, arr) => sum + arr.length, 0);
            if (totalFiltered === 0) {
                showToast('没有符合条件的曲目', 'error');
                return;
            }
            
            let resultSongs = [];
            
            if (state.extractMode === 'equal') {
                const totalCount = parseInt(elements.totalCount.value) || 0;
                if (totalCount <= 0) {
                    showToast('请输入有效的总数量', 'error');
                    return;
                }
                
                for (const game in gameSongMap) {
                    const arr = gameSongMap[game];
                    for (let i = arr.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [arr[i], arr[j]] = [arr[j], arr[i]];
                    }
                }
                
                const games = Object.keys(gameSongMap);
                const indices = {};
                games.forEach(g => indices[g] = 0);
                
                let gameIdx = 0;
                const usedSongs = new Set();
                
                while (resultSongs.length < totalCount) {
                    let found = false;
                    const startIdx = gameIdx;
                    
                    do {
                        const game = games[gameIdx];
                        const songs = gameSongMap[game];
                        const idx = indices[game];
                        
                        if (idx < songs.length) {
                            const song = songs[idx];
                            if (!usedSongs.has(song)) {
                                resultSongs.push(song);
                                usedSongs.add(song);
                                found = true;
                            }
                            indices[game]++;
                        }
                        
                        gameIdx = (gameIdx + 1) % games.length;
                    } while (!found && gameIdx !== startIdx);
                    
                    if (!found) break;
                }
                
                showToast(`已抽取 ${resultSongs.length} 首曲目`);
                
            } else {
                const usedSongs = new Set();
                
                for (const game of selectedGames) {
                    const count = state.customCounts[game] || 0;
                    if (count <= 0) continue;
                    
                    const songs = gameSongMap[game] ? [...gameSongMap[game]] : [];
                    for (let i = songs.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [songs[i], songs[j]] = [songs[j], songs[i]];
                    }
                    
                    let added = 0;
                    for (const song of songs) {
                        if (added >= count) break;
                        if (!usedSongs.has(song)) {
                            resultSongs.push(song);
                            usedSongs.add(song);
                            added++;
                        }
                    }
                }
                
                showToast(`已抽取 ${resultSongs.length} 首曲目`);
            }
            
            elements.songInput.value = resultSongs.map((s, i) => `${i + 1}.${s}`).join('\n');
            state.songInputText = elements.songInput.value;
            saveState();
            
            switchTab('manual');
        }
        
        // ========== 渲染结果 ==========
        function renderResult() {
            const openedSet = new Set(elements.charInput.value);
            const sortedOpened = sortChars(Array.from(openedSet));
            const spaceAsStar = state.spaceAsStar;
            
            if (sortedOpened.length === 0) {
                document.getElementById('sortedCharsDisplay').innerHTML = '<span style="color: var(--muted);">-</span>';
            } else {
                document.getElementById('sortedCharsDisplay').innerHTML = sortedOpened.map(c => 
                    `<span class="char-tag">${escapeHtml(c)}</span>`
                ).join('');
            }
            
            if (state.songs.length === 0) {
                document.getElementById('resultDisplay').innerHTML = '<span style="color: var(--muted);">无曲名数据</span>';
                updateStats(0, 0);
                return;
            }
            
            let html = `<div class="guessed-line">guessed：${escapeHtml(sortedOpened.join(''))}</div>`;
            let totalNonSpace = 0, revealedNonSpace = 0;
            
            state.songs.forEach((song, idx) => {
                const isHidden = state.hiddenIndices.includes(idx);
                const isRevealedFull = state.revealedFullIndices.includes(idx);
                
                const revealedArr = [];
                for (const char of song) {
                    const r = revealChar(char, openedSet, spaceAsStar);
                    revealedArr.push(r);
                    if (char !== ' ' && char !== '　') {
                        totalNonSpace++;
                        if (r !== '*') revealedNonSpace++;
                    }
                }
                const maskedStr = revealedArr.join('');
                
                const hiddenClass = isHidden ? 'hidden-song' : '';
                const revealedClass = isRevealedFull ? 'revealed-full' : '';
                
                html += `<div class="song-line ${hiddenClass} ${revealedClass}" data-index="${idx}">
                    <span class="masked-title"><span class="line-number">${idx + 1}.</span>${formatLineHtml(maskedStr, spaceAsStar)}</span>
                    <span class="full-title"><span class="line-number">${idx + 1}.</span>${escapeHtml(song)}</span>
                    ${isRevealedFull ? '<span class="full-reveal-hint">(点击隐藏)</span>' : ''}
                </div>`;
            });
            
            if (state.remark.trim()) {
                html += `<div class="remark-line">[${escapeHtml(state.remark.trim())}]</div>`;
            }
            
            document.getElementById('resultDisplay').innerHTML = html;
            
            document.querySelectorAll('.song-line').forEach(line => {
                line.addEventListener('click', () => {
                    const idx = parseInt(line.dataset.index);
                    toggleRevealFull(idx);
                });
            });
            
            const visibleCount = state.songs.length - state.hiddenIndices.length;
            const percent = totalNonSpace > 0 ? Math.round(revealedNonSpace / totalNonSpace * 100) : 0;
            
            state.currentRevealPercent = percent;
            
            updateStats(visibleCount, percent);
            updateHideStats();
        }
        
        function formatLineHtml(text, spaceAsStar) {
            return text.split('').map(char => {
                if (char === ' ' || char === '　') {
                    return spaceAsStar ? '<span class="char-hidden">*</span>' : '<span class="char-space"> </span>';
                }
                if (char === '*') return '<span class="char-hidden">*</span>';
                return `<span class="char-revealed">${escapeHtml(char)}</span>`;
            }).join('');
        }
        
        function toggleRevealFull(idx) {
            const i = state.revealedFullIndices.indexOf(idx);
            if (i >= 0) {
                state.revealedFullIndices.splice(i, 1);
            } else {
                state.revealedFullIndices.push(idx);
            }
            saveState();
            renderResult();
        }
        
        function updateStats(songCount, percent) {
            document.getElementById('statSongs').textContent = songCount;
            document.getElementById('statChars').textContent = elements.charInput.value.length;
            document.getElementById('statPercent').textContent = percent + '%';
        }
        
        function updateHideStats() {
            const hideStatsEl = document.getElementById('hideStats');
            const hiddenCountEl = document.getElementById('hiddenCount');
            
            if (state.hiddenIndices.length > 0) {
                hideStatsEl.style.display = 'flex';
                hiddenCountEl.textContent = state.hiddenIndices.length;
            } else {
                hideStatsEl.style.display = 'none';
            }
        }
        
        function updateStatusHint() {
            const hint = document.getElementById('statusHint');
            if (state.songs.length > 0) {
                hint.textContent = `已解析 ${state.songs.length} 首曲名，返回编辑后再次解析将重置游戏`;
                hint.style.color = 'var(--accent)';
            } else {
                hint.textContent = '';
            }
        }
        
        function updateCheckboxStates() {
            const randomChecked = elements.randomSort.checked;
            const lengthChecked = elements.lengthSort.checked;
            elements.lengthSortLabel.classList.toggle('disabled', randomChecked);
            elements.randomSortLabel.classList.toggle('disabled', lengthChecked);
        }
        
        // ========== 隐藏功能 ==========
        function hideRevealedSongs() {
            if (state.revealedFullIndices.length === 0) {
                showToast('没有已猜出的曲目，请先点击曲目显示完整曲名', 'info');
                return;
            }
            
            for (const idx of state.revealedFullIndices) {
                if (!state.hiddenIndices.includes(idx)) {
                    state.hiddenIndices.push(idx);
                    state.guessedSongs.push({
                        index: idx,
                        time: state.timerSeconds
                    });
                }
            }
            
            const count = state.revealedFullIndices.length;
            state.revealedFullIndices = [];
            
            saveState();
            renderResult();
            showToast(`已隐藏 ${count} 首已猜出的曲目`);
        }
        
        // ========== 恢复游戏弹窗 ==========
        function showRestoreModal() {
            document.getElementById('restoreSongCount').textContent = (state.songs.length - state.hiddenIndices.length) + ' 首';
            document.getElementById('restoreCharCount').textContent = state.openedChars.length + ' 个';
            document.getElementById('restoreTime').textContent = formatTime(state.timerSeconds);
            document.getElementById('restorePercent').textContent = state.currentRevealPercent + '%';
            
            document.getElementById('restoreModal').classList.add('show');
        }
        
        function hideRestoreModal() {
            document.getElementById('restoreModal').classList.remove('show');
        }
        
        // ========== 文件处理 ==========
        async function handleFile(file) {
            if (!file.name.endsWith('.txt')) {
                showToast('请上传 TXT 格式文件', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                const text = e.target.result;
                processLibraryText(text, file.name);
            };
            
            reader.onerror = () => showToast('文件读取失败', 'error');
            reader.readAsText(file);
        }
        
        // 处理曲库文本
        async function processLibraryText(text, fileName = '在线曲库') {
            const data = parseLibrary(text);
            
            if (Object.keys(data).length === 0) {
                showToast('未能识别任何有效游戏标签', 'error');
                return;
            }
            
            gameData = data;
            state.fileName = fileName;
            state.selectedGames = [];
            state.customCounts = {};
            
            document.getElementById('fileName').textContent = fileName;
            elements.parsedSection.style.display = 'block';
            
            renderGameList();
            saveState();
            
            try {
                await saveToDB('gameData', gameData);
            } catch (e) {
                console.warn('保存曲库到IndexedDB失败:', e);
            }
            
            const gameCount = Object.keys(gameData).length;
            const songCount = Object.values(gameData).reduce((sum, arr) => sum + arr.length, 0);
            showToast(`成功解析 ${gameCount} 个游戏、${songCount} 首曲目`);
        }
        
        // 导入在线曲库
        async function importOnlineLibrary() {
            const btn = document.getElementById('importOnlineBtn');
            const originalContent = btn.innerHTML;
            
            btn.disabled = true;
            btn.innerHTML = `
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="animate-spin">
                    <circle cx="12" cy="12" r="10" stroke-opacity="0.25"/>
                    <path d="M12 2a10 10 0 0 1 10 10" stroke-opacity="1"/>
                </svg>
                正在导入...
            `;
            
            try {
                const response = await fetch(ONLINE_LIBRARY_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const text = await response.text();
                await processLibraryText(text, '在线曲库');
            } catch (error) {
                console.error('导入在线曲库失败:', error);
                showToast('导入在线曲库失败，请检查网络连接', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalContent;
            }
        }
        
        // ========== 初始化 ==========
        async function init() {
            elements = {
                toast: document.getElementById('toast'),
                songInput: document.getElementById('songInput'),
                remarkInput: document.getElementById('remarkInput'),
                charInput: document.getElementById('charInput'),
                randomSort: document.getElementById('randomSort'),
                lengthSort: document.getElementById('lengthSort'),
                randomSortLabel: document.getElementById('randomSortLabel'),
                lengthSortLabel: document.getElementById('lengthSortLabel'),
                sortToggle: document.getElementById('sortToggle'),
                sortContent: document.getElementById('sortContent'),
                spaceAsStar: document.getElementById('spaceAsStar'),
                hideRevealed: document.getElementById('hideRevealed'),
                uploadZone: document.getElementById('uploadZone'),
                fileInput: document.getElementById('fileInput'),
                parsedSection: document.getElementById('parsedSection'),
                gameList: document.getElementById('gameList'),
                modeEqual: document.getElementById('modeEqual'),
                modeCustom: document.getElementById('modeCustom'),
                equalMode: document.getElementById('equalMode'),
                customMode: document.getElementById('customMode'),
                customCountsDiv: document.getElementById('customCounts'),
                totalCount: document.getElementById('totalCount'),
                generateBtn: document.getElementById('generateBtn'),
                selectAll: document.getElementById('selectAll'),
                selectNone: document.getElementById('selectNone'),
                clearFile: document.getElementById('clearFile'),
                importOnlineBtn: document.getElementById('importOnlineBtn')
            };
            
            try {
                await openDB();
            } catch (e) {
                console.error('IndexedDB打开失败:', e);
            }
            
            loadState();
            
            elements.songInput.value = state.songInputText || '';
            elements.remarkInput.value = state.remark || '';
            elements.spaceAsStar.checked = state.spaceAsStar || false;
            elements.totalCount.value = state.totalCount || 10;
            
            if (state.sortType === 'random') {
                elements.randomSort.checked = true;
            } else if (state.sortType === 'length') {
                elements.lengthSort.checked = true;
            }
            
            updateCheckboxStates();
            
            // 尝试加载已保存的曲库数据
            try {
                const savedGameData = await loadFromDB('gameData');
                if (savedGameData && Object.keys(savedGameData).length > 0) {
                    gameData = savedGameData;
                    document.getElementById('fileName').textContent = state.fileName || '已加载曲库';
                    elements.parsedSection.style.display = 'block';
                    renderGameList();
                    
                    // 恢复过滤状态
                    state.filters.only.forEach(f => {
                        document.querySelector(`.filter-options[data-filter-type="only"] .filter-chip[data-filter="${f}"]`)?.classList.add('active');
                    });
                    state.filters.include.forEach(f => {
                        document.querySelector(`.filter-options[data-filter-type="include"] .filter-chip[data-filter="${f}"]`)?.classList.add('active');
                    });
                    state.filters.exclude.forEach(f => {
                        document.querySelector(`.filter-options[data-filter-type="exclude"] .filter-chip[data-filter="${f}"]`)?.classList.add('active');
                    });
                    
                    // 恢复抽取模式
                    if (state.extractMode === 'custom') {
                        elements.modeEqual.classList.remove('active');
                        elements.modeCustom.classList.add('active');
                        elements.equalMode.style.display = 'none';
                        elements.customMode.style.display = 'block';
                    }
                }
            } catch (e) {
                console.warn('加载曲库数据失败:', e);
            }
            
            switchTab(state.activeTab || 'import');
            
            // 检查是否有未完成的游戏
            if (state.currentPage === 2 && state.songs.length > 0) {
                // 有未完成的游戏，显示恢复弹窗
                showRestoreModal();
            } else {
                // 没有未完成的游戏，正常显示编辑页
                updateStatusHint();
                switchToPage(1);
            }
            
            bindEvents();
        }
        
        function bindEvents() {
            // 标签页切换
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => switchTab(btn.dataset.tab));
            });
            
            elements.randomSort.addEventListener('change', () => {
                if (elements.randomSort.checked) elements.lengthSort.checked = false;
                updateCheckboxStates();
                saveState();
            });
            
            elements.lengthSort.addEventListener('change', () => {
                if (elements.lengthSort.checked) elements.randomSort.checked = false;
                updateCheckboxStates();
                saveState();
            });
            
            elements.sortToggle.addEventListener('click', () => {
                const isOpen = elements.sortContent.classList.contains('open');
                elements.sortContent.classList.toggle('open');
                elements.sortToggle.classList.toggle('expanded', !isOpen);
            });
            
            document.getElementById('applySort').addEventListener('click', () => {
                let songs = parseSongs(elements.songInput.value);
                if (songs.length === 0) {
                    showToast('请先输入曲名', 'error');
                    return;
                }
                if (elements.randomSort.checked) {
                    for (let i = songs.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [songs[i], songs[j]] = [songs[j], songs[i]];
                    }
                    showToast('已随机排列');
                } else if (elements.lengthSort.checked) {
                    songs.sort((a, b) => a.length - b.length);
                    showToast('已按长度排列');
                } else {
                    showToast('请先选择排列方式', 'error');
                    return;
                }
                elements.songInput.value = songs.map((s, i) => `${i + 1}.${s}`).join('\n');
                saveState();
            });
            
            document.getElementById('clearSongs').addEventListener('click', () => {
                elements.songInput.value = '';
                saveState();
                showToast('已清空曲名');
            });
            
            elements.spaceAsStar.addEventListener('change', saveState);
            
            // 文件上传相关
            elements.uploadZone.addEventListener('click', () => elements.fileInput.click());
            
            elements.uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                elements.uploadZone.classList.add('dragover');
            });
            
            elements.uploadZone.addEventListener('dragleave', () => {
                elements.uploadZone.classList.remove('dragover');
            });
            
            elements.uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                elements.uploadZone.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file) handleFile(file);
            });
            
            elements.fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) handleFile(file);
            });
            
            // 在线曲库导入
            elements.importOnlineBtn.addEventListener('click', importOnlineLibrary);
            
            elements.clearFile.addEventListener('click', async () => {
                gameData = {};
                state.selectedGames = [];
                state.fileName = '';
                elements.parsedSection.style.display = 'none';
                elements.fileInput.value = '';
                try { await saveToDB('gameData', {}); } catch (e) {}
                saveState();
                showToast('已移除曲库');
            });
            
            elements.selectAll.addEventListener('click', () => {
                elements.gameList.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
                updateCustomCounts();
                updateFilterCount();
                saveState();
            });
            
            elements.selectNone.addEventListener('click', () => {
                elements.gameList.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                updateCustomCounts();
                updateFilterCount();
                saveState();
            });
            
            elements.gameList.addEventListener('change', (e) => {
                if (e.target.type === 'checkbox') {
                    updateCustomCounts();
                    updateFilterCount();
                    saveState();
                }
            });
            
            // 过滤器
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.addEventListener('click', () => {
                    chip.classList.toggle('active');
                    updateFilterCount();
                    saveState();
                });
            });
            
            document.getElementById('clearFilters').addEventListener('click', () => {
                document.querySelectorAll('.filter-chip').forEach(chip => chip.classList.remove('active'));
                state.filters = { only: [], include: [], exclude: [] };
                updateFilterCount();
                saveState();
            });
            
            // 抽取模式切换
            elements.modeEqual.addEventListener('click', () => {
                elements.modeEqual.classList.add('active');
                elements.modeCustom.classList.remove('active');
                elements.equalMode.style.display = 'block';
                elements.customMode.style.display = 'none';
                state.extractMode = 'equal';
                saveState();
            });
            
            elements.modeCustom.addEventListener('click', () => {
                elements.modeCustom.classList.add('active');
                elements.modeEqual.classList.remove('active');
                elements.customMode.style.display = 'block';
                elements.equalMode.style.display = 'none';
                state.extractMode = 'custom';
                updateCustomCounts();
                saveState();
            });
            
            elements.generateBtn.addEventListener('click', generateSongs);
            
            elements.customCountsDiv.addEventListener('input', (e) => {
                if (e.target.classList.contains('custom-count-input')) {
                    saveState();
                }
            });
            
            elements.totalCount.addEventListener('input', saveState);
            
            document.getElementById('parseBtn').addEventListener('click', () => {
                const songs = parseSongs(elements.songInput.value);
                if (songs.length === 0) {
                    showToast('请输入至少一首曲名', 'error');
                    return;
                }
                
                resetTimer();
                state.songs = songs;
                state.remark = elements.remarkInput.value.trim();
                state.spaceAsStar = elements.spaceAsStar.checked;
                state.openedChars = '';
                state.hiddenIndices = [];
                state.revealedFullIndices = [];
                state.guessedSongs = [];
                state.currentRevealPercent = 0;
                elements.charInput.value = '';
                
                saveState();
                showToast('游戏开始！');
                switchToPage(2);
            });
            
            document.getElementById('backBtn').addEventListener('click', () => {
                if (confirm('返回编辑将结束当前游戏，确定吗？')) {
                    stopTimer();
                    clearGameState();
                    switchToPage(1);
                }
            });
            
            elements.songInput.addEventListener('input', saveState);
            elements.remarkInput.addEventListener('input', saveState);
            
            elements.charInput.addEventListener('input', () => {
                state.openedChars = elements.charInput.value;
                saveState();
                renderResult();
            });
            
            document.getElementById('resetChars').addEventListener('click', () => {
                elements.charInput.value = '';
                state.openedChars = '';
                saveState();
                renderResult();
                showToast('已重置所有开启字符');
            });
            
            elements.hideRevealed.addEventListener('click', hideRevealedSongs);
            
            document.getElementById('pauseBtn').addEventListener('click', pauseTimer);
            
            document.getElementById('endGameBtn').addEventListener('click', () => {
                if (confirm('确定要结束游戏吗？')) {
                    showSettlement();
                }
            });
            
            document.getElementById('copyBtn').addEventListener('click', async () => {
                if (state.songs.length === 0) {
                    showToast('没有可复制的内容', 'error');
                    return;
                }
                
                const openedSet = new Set(elements.charInput.value);
                const sortedOpened = sortChars(Array.from(openedSet));
                const spaceAsStar = state.spaceAsStar;
                
                let text = `guessed：${sortedOpened.join('')}\n`;
                
                state.songs.forEach((song, idx) => {
                    if (state.hiddenIndices.includes(idx)) return;
                    
                    if (state.revealedFullIndices.includes(idx)) {
                        text += `${idx + 1}.${song}\n`;
                    } else {
                        const revealed = [];
                        for (const char of song) {
                            revealed.push(revealChar(char, openedSet, spaceAsStar));
                        }
                        text += `${idx + 1}.${revealed.join('')}\n`;
                    }
                });
                
                if (state.remark.trim()) {
                    text += `[${state.remark.trim()}]`;
                }
                
                try {
                    await navigator.clipboard.writeText(text.trim());
                    showToast('已复制到剪贴板');
                } catch (e) {
                    const textarea = document.createElement('textarea');
                    textarea.value = text.trim();
                    textarea.style.cssText = 'position:fixed;left:-9999px;';
                    document.body.appendChild(textarea);
                    textarea.select();
                    try {
                        document.execCommand('copy');
                        showToast('已复制到剪贴板');
                    } catch (err) {
                        showToast('复制失败，请手动复制', 'error');
                    }
                    document.body.removeChild(textarea);
                }
            });
            
            document.getElementById('copySettlement').addEventListener('click', async () => {
                const text = document.getElementById('settlementText').value;
                try {
                    await navigator.clipboard.writeText(text);
                    showToast('已复制结算信息');
                } catch (e) {
                    const textarea = document.createElement('textarea');
                    textarea.value = text;
                    textarea.style.cssText = 'position:fixed;left:-9999px;';
                    document.body.appendChild(textarea);
                    textarea.select();
                    try {
                        document.execCommand('copy');
                        showToast('已复制结算信息');
                    } catch (err) {
                        showToast('复制失败', 'error');
                    }
                    document.body.removeChild(textarea);
                }
            });
            
            document.getElementById('copyQuestions').addEventListener('click', async () => {
                const text = document.getElementById('questionsText').value;
                try {
                    await navigator.clipboard.writeText(text);
                    showToast('已复制完整题面');
                } catch (e) {
                    const textarea = document.createElement('textarea');
                    textarea.value = text;
                    textarea.style.cssText = 'position:fixed;left:-9999px;';
                    document.body.appendChild(textarea);
                    textarea.select();
                    try {
                        document.execCommand('copy');
                        showToast('已复制完整题面');
                    } catch (err) {
                        showToast('复制失败', 'error');
                    }
                    document.body.removeChild(textarea);
                }
            });
            
            document.getElementById('newGameBtn').addEventListener('click', () => {
                resetTimer();
                state.songs = [];
                state.hiddenIndices = [];
                state.revealedFullIndices = [];
                state.guessedSongs = [];
                state.openedChars = '';
                state.currentRevealPercent = 0;
                elements.charInput.value = '';
                switchToPage(1);
            });
            
            document.getElementById('backToEditBtn').addEventListener('click', () => {
                switchToPage(1);
            });
            
            // 恢复游戏弹窗按钮
            document.getElementById('restoreContinue').addEventListener('click', () => {
                hideRestoreModal();
                elements.charInput.value = state.openedChars || '';
                switchToPage(2, true);
                showToast('已恢复游戏，计时器已暂停，点击「继续」继续计时');
            });
            
            document.getElementById('restoreNewGame').addEventListener('click', () => {
                hideRestoreModal();
                clearGameState();
                elements.charInput.value = '';
                updateStatusHint();
                switchToPage(1);
            });
        }
        
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
